<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="/css/admin.css">
</head>
<body>
<!--<div th:replace="~{fragments/header :: header}" /><br>-->
<div id="slideCard">
    <h1> 슬라이드 카드 설정 </h1>

        <table id="slideTable">
            <tr>
                <th th:width="50"> # </th>
                <th th:width="80">슬라이드 순서</th>
                <th th:width="300">도서 제목</th>
                <th th:width="150">도서 ISBN13</th>
                <th th:width="100">등록일자</th>
                <th th:width="200">슬라이드 파일</th>
                <th> 삭제 </th>
            </tr>
            <tr th:each="card, index : ${slideCard}" draggable="true" id="slide">
                <td th:text="${index.index + 1}">1</td>
                <td>
                    <!--                <select>-->
                    <!--                    <option th:each="orderOption : ${#numbers.sequence(1, slideCard.size())}"-->
                    <!--                            th:id="'orderSelect_' + ${index.index}"-->
                    <!--                            th:value="${card.idx}"-->
                    <!--                            th:onclick="'updateIndexes(' + ${index.index} + ')'"-->
                    <!--                            onchange="updateIndexes(${index.index})">-->
                    <!--                        order-->
                    <!--                    </option>-->
                    <!--                </select>-->
                    <select onchange="updateIndexes(this)">
                        <option th:each="orderOption : ${#numbers.sequence(1, slideCard.size())}"
                                th:value="${orderOption}"
                                th:text="${orderOption}"
                                th:selected="${orderOption == card.idx}">
                            order
                        </option>
                    </select>
                </td>
                <td th:if="${card.book == null}"> ISBN13 값이 잘못 되었습니다. 삭제 후 재생성 바람. </td>
                <td th:unless="${card.book == null}" th:text="${card.book.getTitle()}">데일 카네기 인간관계론</td>
                <td th:text="${card.ISBN13}"> 9791187142560 </td>
                <td th:text="${card.addDate}">2024-04-07</td>
                <td>
                    <img th:src="@{/images/slides/{fileName}(fileName=${card.slideFileName})}" th:alt="${card.slideFileName}">
<!--                    <input type="file" th:value="${card.slideFileName}" readonly>-->
                </td>
                <td>
                    <input type="button" value="삭제" th:onclick="|location.href='/slide/'+ @{${card.id}} |"/>

                </td>
            </tr>
        </table>

    <form id="slideForm" action="/slide" method="post" enctype="multipart/form-data">
        <span> ISBN13 입력 : </span>
        <input type="number" name="ISBN13" id="ISBN13" placeholder="13자리를 입력해 주세요."/> <br>
        <span> 슬라이드 파일 (파일 형식 JPG 또는 PNG / 파일 사이즈 1280 x 400 px) : </span><br>
        <input type="file" name="file" id="file"/>
        <input type="hidden" name="idx" th:value="${slideCard.size()+1}">
        <input type="button" onclick="fileUpload(form)" value="업로드">
    </form>

</div>
</body>
</html>

<script>
    let slideTable = document.querySelector('#slideTable');
    let slides = document.querySelectorAll('#slide');

    slides.forEach(slide =>{
        slide.addEventListener("dragstart", ()=>{
            slide.classList.add('drag');
        })
        slide.addEventListener("dragend", ()=>{
            slide.classList.remove('drag');
        })
    })

    slideTable.addEventListener("drop", e => {
        e.preventDefault();
        const draggedSlide = document.querySelector('.drag');
        const targetSlide = e.target.closest('tr');
        if (draggedSlide !== targetSlide) {
            const slideParent = draggedSlide.parentNode;
            const draggedIndex = Array.from(slideParent.children).indexOf(draggedSlide);
            const targetIndex = Array.from(slideParent.children).indexOf(targetSlide);
            if (draggedIndex < targetIndex) {
                slideParent.insertBefore(draggedSlide, targetSlide.nextSibling);
            } else {
                slideParent.insertBefore(draggedSlide, targetSlide);
            }
        }
    });

    function fileUpload(form) {
        let isbnInput = document.getElementById('ISBN13');
        let fileInput = document.getElementById('file');
        let check = true;

        // ISBN13이 13자리인지 확인
        if (isbnInput.value.length !== 13) {
            alert('ISBN13은 13자리여야 합니다.');
            check = false;
        }

        // 파일이 JPG 또는 PNG인지 확인
        let allowedExtensions = /(\.jpg|\.jpeg|\.png)$/i;
        if (!allowedExtensions.exec(fileInput.value)) {
            alert('JPG 또는 PNG 파일만 허용됩니다.');
            check = false;

        }

        // 파일 크기가 1280x400 픽셀인지 확인
        let img = new Image();
        img.src = URL.createObjectURL(fileInput.files[0]);
        if (img.width !== 1280 || img.height !== 400) {
            check = false;
            console.log(check);
            alert('파일의 크기는 1280x400 픽셀이어야 합니다.');
        }

        if(check) {
            console.log(check);
            form.submit();
        }
        return false;
    }



</script>
